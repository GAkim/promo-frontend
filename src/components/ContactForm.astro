---
/**
 * Contact Form Component
 * 
 * Features:
 * - Honeypot field for bot detection (hidden via CSS)
 * - Google reCAPTCHA v2 widget
 * - Client-side validation
 * - Submit button loading state
 * - Success/error message display
 */

interface Props {
  lang: string;
  siteKey: string;
}

const { lang, siteKey } = Astro.props;

const labels = {
  lv: {
    title: 'Sazinieties ar mums',
    name: 'Jūsu vārds',
    email: 'E-pasts',
    subject: 'Temats',
    message: 'Ziņa',
    submit: 'Nosūtīt',
    submitting: 'Nosūta...',
    success: 'Jūsu ziņa ir nosūtīta!',
    error: 'Notikusi kļūda. Lūdzu, mēģiniet vēlreiz.',
    errorTooMany: 'Pārāk daudz mēģinājumu. Lūdzu, uzgaidiet.',
    errorCaptcha: 'Lūdzu, apstipriniet, ka neesat robots.',
    errorConsent: 'Lūdzu, piekrītiet datu apstrādei.',
    namePlaceholder: 'Jānis Bērziņš',
    emailPlaceholder: 'janis@piemers.lv',
    subjectPlaceholder: 'Jautājums par piedāvājumu',
    messagePlaceholder: 'Rakstiet savu ziņu šeit...',
    consentLabel: 'Es piekrītu personas datu apstrādei',
  },
  en: {
    title: 'Contact Us',
    name: 'Your Name',
    email: 'Email',
    subject: 'Subject',
    message: 'Message',
    submit: 'Send Message',
    submitting: 'Sending...',
    success: 'Your message has been sent successfully!',
    error: 'Something went wrong. Please try again.',
    errorTooMany: 'Too many attempts. Please wait.',
    errorCaptcha: 'Please complete the reCAPTCHA.',
    errorConsent: 'Please agree to data processing.',
    namePlaceholder: 'John Doe',
    emailPlaceholder: 'john@example.com',
    subjectPlaceholder: 'Question about promo code',
    messagePlaceholder: 'Write your message here...',
    consentLabel: 'I agree to the processing of personal data',
  },
  ru: {
    title: 'Свяжитесь с нами',
    name: 'Ваше имя',
    email: 'Email',
    subject: 'Тема',
    message: 'Сообщение',
    submit: 'Отправить',
    submitting: 'Отправка...',
    success: 'Ваше сообщение успешно отправлено!',
    error: 'Что-то пошло не так. Пожалуйста, попробуйте снова.',
    errorTooMany: 'Слишком много попыток. Пожалуйста, подождите.',
    errorCaptcha: 'Пожалуйста, пройдите reCAPTCHA.',
    errorConsent: 'Пожалуйста, согласитесь на обработку данных.',
    namePlaceholder: 'Иван Иванов',
    emailPlaceholder: 'ivan@example.com',
    subjectPlaceholder: 'Вопрос о промокоде',
    messagePlaceholder: 'Напишите ваше сообщение здесь...',
    consentLabel: 'Я согласен на обработку персональных данных',
  },
};

const t = labels[lang] || labels.en;
---

<div class="max-w-2xl mx-auto">
  <h2 class="text-3xl font-bold text-gray-900 mb-6">{t.title}</h2>
  
  <form id="contact-form" class="space-y-6" novalidate>
    <!-- Name Field -->
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
        {t.name} *
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        maxlength="100"
        placeholder={t.namePlaceholder}
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors text-gray-900"
      />
    </div>

    <!-- Email Field -->
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
        {t.email} *
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        maxlength="255"
        placeholder={t.emailPlaceholder}
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors text-gray-900"
      />
    </div>

    <!-- Subject Field -->
    <div>
      <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">
        {t.subject} *
      </label>
      <input
        type="text"
        id="subject"
        name="subject"
        required
        maxlength="200"
        placeholder={t.subjectPlaceholder}
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors text-gray-900"
      />
    </div>

    <!-- Message Field -->
    <div>
      <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
        {t.message} *
      </label>
      <textarea
        id="message"
        name="message"
        required
        maxlength="2000"
        rows="5"
        placeholder={t.messagePlaceholder}
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors text-gray-900 resize-none"
      ></textarea>
      <p class="mt-1 text-sm text-gray-500"><span id="char-count">0</span>/2000</p>
    </div>

    <!-- Honeypot Field (hidden from humans, bots will fill it) -->
    <div class="honeypot-field" aria-hidden="true">
      <label for="website_url">Leave this empty</label>
      <input
        type="text"
        id="website_url"
        name="website_url"
        tabindex="-1"
        autocomplete="off"
      />
    </div>

    <!-- Consent Checkbox -->
    <div class="flex items-start">
      <input
        type="checkbox"
        id="consent"
        name="consent"
        required
        class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
      />
      <label for="consent" class="ml-2 text-sm text-gray-700">
        {t.consentLabel} *
      </label>
    </div>

    <!-- reCAPTCHA Widget (hidden in dev mode) -->
    <div class="g-recaptcha" data-sitekey={siteKey} data-autohide={import.meta.env.DEV}></div>

    <!-- Submit Button -->
    <button
      type="submit"
      id="submit-btn"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {t.submit}
    </button>

    <!-- Status Messages -->
    <div id="form-message" class="hidden p-4 rounded-lg" role="alert"></div>
  </form>
</div>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const messageDiv = document.getElementById('form-message') as HTMLDivElement;
  const messageTextarea = document.getElementById('message') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count') as HTMLSpanElement;
  const currentLang = "{lang}";

  const messages = {
    lv: {
      success: 'Jūsu ziņa ir nosūtīta!',
      error: 'Notikusi kļūda. Lūdzu, mēģiniet vēlreiz.',
      errorTooMany: 'Pārāk daudz mēģinājumu. Lūdzu, uzgaidiet ',
      errorCaptcha: 'Lūdzu, apstipriniet, ka neesat robots.',
      errorConsent: 'Lūdzu, piekrītiet datu apstrādei.',
    },
    en: {
      success: 'Your message has been sent successfully!',
      error: 'Something went wrong. Please try again.',
      errorTooMany: 'Too many attempts. Please wait ',
      errorCaptcha: 'Please complete the reCAPTCHA.',
      errorConsent: 'Please agree to data processing.',
    },
    ru: {
      success: 'Ваше сообщение успешно отправлено!',
      error: 'Что-то пошло не так. Пожалуйста, попробуйте снова.',
      errorTooMany: 'Слишком много попыток. Пожалуйста, подождите ',
      errorCaptcha: 'Пожалуйста, пройдите reCAPTCHA.',
      errorConsent: 'Пожалуйста, согласитесь на обработку данных.',
    },
  };

  const t = messages[currentLang] || messages.en;

  // Character counter
  messageTextarea?.addEventListener('input', () => {
    if (charCount) {
      charCount.textContent = messageTextarea.value.length.toString();
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Reset previous messages
    messageDiv.classList.add('hidden');
    messageDiv.className = 'hidden p-4 rounded-lg';

    // Get form data
    const formData = new FormData(form);
    const name = formData.get('name') as string;
    const email = formData.get('email') as string;
    const subject = formData.get('subject') as string;
    const message = formData.get('message') as string;
    const honeypot = formData.get('website_url') as string;
    const consent = formData.get('consent') as string;

    // Client-side validation
    if (!name || !email || !subject || !message) {
      showMessage(t.error, 'error');
      return;
    }

    // Check consent
    if (!consent) {
      showMessage(t.errorConsent, 'error');
      return;
    }

    // Get reCAPTCHA token
    const recaptchaToken = (window as any).grecaptcha?.getResponse();
    // Validate reCAPTCHA (always validate in production, optional in dev if keys are configured)
    const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const requireCaptcha = !isDev || (import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY && import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY !== 'your_site_key_here');
    
    if (requireCaptcha && (!recaptchaToken || recaptchaToken.trim() === '')) {
      showMessage(t.errorCaptcha, 'error');
      return;
    }
    
    // Disable button during submission
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = currentLang === 'lv' ? 'Nosūta...' : currentLang === 'ru' ? 'Отправка...' : 'Sending...';
    
    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          email,
          subject,
          message,
          recaptchaToken,
          website_url: honeypot, // Send honeypot for server-side check
        }),
      });
      
      const result = await response.json();
      
      if (response.ok) {
        showMessage(t.success, 'success');
        form.reset();
        if (charCount) charCount.textContent = '0';
        (window as any).grecaptcha?.reset();
      } else if (response.status === 429) {
        const retryAfter = result.retryAfter || 3600;
        const minutes = Math.ceil(retryAfter / 60);
        showMessage(`${t.errorTooMany}(${minutes} min)`, 'error');
      } else {
        showMessage(result.error || t.error, 'error');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showMessage(t.error, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  function showMessage(text: string, type: 'success' | 'error') {
    messageDiv.textContent = text;
    messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
    if (type === 'success') {
      messageDiv.classList.add('bg-green-100', 'text-green-800');
    } else {
      messageDiv.classList.add('bg-red-100', 'text-red-800');
    }
    messageDiv.classList.remove('hidden');
  }
</script>

<style>
  /* Honeypot field - hidden from humans but visible to bots */
  .honeypot-field {
    position: absolute;
    left: -9999px;
    top: -9999px;
    opacity: 0;
    height: 0;
    width: 0;
    overflow: hidden;
  }
</style>
