---
import { getStrapiMediaUrl } from "../lib/strapi";
import type { PromoCode } from "../types/strapi";

export interface Props {
  promo: PromoCode;
  lang: string;
  htmlDescription?: string;
}

const { promo, lang, htmlDescription } = Astro.props;

const copyLabels: Record<string, string> = {
  lv: "Kopēt",
  en: "Copy",
  ru: "Копировать",
};

const visitLabels: Record<string, string> = {
  lv: "Apmeklēt",
  en: "Visit",
  ru: "Посетить",
};

const expiryLabels: Record<string, string> = {
  lv: "Spēkā līdz:",
  en: "Valid until:",
  ru: "Действует до:",
};

function formatExpiryDate(dateString: string | null, locale: string): string {
  if (!dateString) return "";
  const date = new Date(dateString);
  return date.toLocaleDateString(
    locale === "lv" ? "lv-LV" : locale === "ru" ? "ru-RU" : "en-US",
    {
      year: "numeric",
      month: "long",
      day: "numeric",
    },
  );
}
---

<div
  class="bg-white rounded-lg shadow-sm border overflow-hidden hover:shadow-md transition-shadow"
>
  <div class="p-6">
    <!-- Header with logo -->
    <div class="flex items-center gap-4 mb-4">
      {
        promo?.logo ? (
          <img
            src={getStrapiMediaUrl(promo?.logo)}
            alt={promo?.brand?.name || "Brand logo"}
            class="w-12 h-12 object-contain"
            loading="lazy"
          />
        ) : (
          <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
            <span class="text-gray-400 text-sm font-semibold">
              {promo.brand?.name?.[0]?.toUpperCase() || "?"}
            </span>
          </div>
        )
      }
      <div>
        <h3 class="font-semibold text-gray-900">{promo.title}</h3>
        <p class="text-sm text-gray-500">{promo.brand?.name}</p>
      </div>
    </div>

    <!-- Code with copy button -->
    <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-3 mb-4">
      <code class="flex-1 text-lg font-mono font-bold text-blue-600"
        >{promo.code}</code
      >
      <button
        type="button"
        onclick={`navigator.clipboard.writeText('${promo.code}').then(() => alert('${copyLabels[lang]}: ${promo.code}'));`}
        class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-xs font-medium whitespace-nowrap"
      >
        {copyLabels[lang]}
      </button>
    </div>

    <!-- Description -->
    {
      htmlDescription && (
        <div
          class="text-gray-600 text-sm mb-4 prose prose-sm max-w-none"
          set:html={htmlDescription}
        />
      )
    }

    <!-- Category -->
    {
      promo.category && (
        <p class="text-xs text-gray-500 mb-2">{promo.category.name}</p>
      )
    }

    <!-- Expiry Date -->
    {
      promo.expiryDate && (
        <p class="text-xs text-gray-500 mb-4">
          {expiryLabels[lang]} {formatExpiryDate(promo.expiryDate, lang)}
        </p>
      )
    }

    <!-- Actions -->
    <div class="flex gap-2">
      {
        promo.affiliateLink && (
          <a
            href={promo.affiliateLink}
            target="_blank"
            rel="noopener noreferrer"
            class="flex-1 px-4 py-2 bg-blue-600 text-white text-center rounded hover:bg-blue-700 transition-colors text-sm font-medium"
          >
            {visitLabels[lang]}
          </a>
        )
      }
    </div>
  </div>
</div>
